<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.example.demo.system.mapper.UserMapper">
    <!-- 分页查询：关联角色表，拼接角色名称 -->
    <select id="queryByPage" resultType="com.example.demo.system.model.dto.UserDTO">
        select
        u.id,
        u.account,
        u.username,
        u.email,
        u.gender,
        u.phone,
        u.status,
        u.is_enable,
        u.create_by,
        u.create_time,
        u.update_by,
        u.update_time,
        -- 关联查询角色名称，用 GROUP_CONCAT 替代子查询（避免重复行，自动拼接逗号）
        GROUP_CONCAT(DISTINCT r.name SEPARATOR ',') as roles
        from sys_user u
        -- 左关联用户角色表 + 角色表（原 XML 缺失关联表，补充完整）
        left join sys_user_role ur on u.id = ur.user_id
        left join sys_role r on ur.role_id = r.id
        where 1=1
        ${ew.sqlSegment}
        group by u.id
    </select>
</mapper>